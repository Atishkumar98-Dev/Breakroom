{% load static %}
<!DOCTYPE html>
<html>
<head>
  <title>BREAKROOM POS</title>
  <link rel="stylesheet" href="{% static 'billing/style.css' %}">
</head>
<body>

{% if messages %}
  <div class="msgbox">
    {% for message in messages %}
      <p class="msg">{{ message }}</p>
    {% endfor %}
  </div>
{% endif %}

<div class="topbar">
  <div class="brand">
    <img src="{% static 'billing/logo.png' %}" class="logo">
    <div>
      <h1>BREAKROOM</h1>
      <p>Play ‚Ä¢ Eat ‚Ä¢ Repeat</p>
    </div>
  </div>

  <div class="billinfo">
    <h3>{{ bill.bill_no }}</h3>
    <small>Category: <b style="color:#f5c400">{{ bill.bill_category }}</b></small>
  </div>
</div>

<div class="grid">

  <!-- ‚úÖ CUSTOMER DETAILS -->
  <div class="card wide">
    <h2>üë§ Customer Details</h2>
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="action" value="save_customer">
      <div class="row3">
        <input name="customer_name" placeholder="Customer Name" value="{{ customer_name }}" required>
        <input name="customer_phone" placeholder="Phone (optional)" value="{{ customer_phone }}">
        <input name="customer_email" placeholder="Email (required)" value="{{ customer_email }}" required>
      </div>
      <button class="btn">‚úÖ Save Customer</button>
    </form>
  </div>


  <!-- üé± POOL -->
  <div class="card">
    <h2>üé± Pool Table</h2>

    <p class="status">
      Table 1: {% if pool1_busy %}<span class="busy">BUSY</span>{% else %}<span class="free">AVAILABLE</span>{% endif %}
      |
      Table 2: {% if pool2_busy %}<span class="busy">BUSY</span>{% else %}<span class="free">AVAILABLE</span>{% endif %}
    </p>

    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="action" value="add_pool">

      <label>Select Table</label>
      <select name="pool_table" required>
        <option value="">Select</option>
        <option value="1">Table 1</option>
        <option value="2">Table 2</option>
      </select>

      <label>Duration</label>
      <select name="pool_duration" id="pool_duration" required>
        <option value="">Select</option>
        <option value="30">Half Hour (Rs.150)</option>
        <option value="60">1 Hour (Rs.250)</option>
      </select>

      <label>From Time</label>
      <input type="time" name="from_time" id="pool_from" required>

      <label>To Time (Auto)</label>
      <input type="time" id="pool_to" disabled>

      <button class="btn">‚ûï Add Pool</button>
    </form>
  </div>


  <!-- üéÆ PS5 -->
  <div class="card">
    <h2>üéÆ PS5 (Per Controller)</h2>

    <p class="status">
  PS5 65": {% if ps5_65_busy %}<span class="busy">BUSY</span>{% else %}<span class="free">AVAILABLE</span>{% endif %}
  |
  PS5 55": {% if ps5_55_busy %}<span class="busy">BUSY</span>{% else %}<span class="free">AVAILABLE</span>{% endif %}
</p>
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="action" value="add_ps5">
      <label>PS5 Setup</label>
    <select name="ps5_tv" required>
      <option value="">Select TV</option>
      <option value="65">PS5 (65 Inch)</option>
      <option value="55">PS5 (55 Inch)</option>
    </select>
      <label>Controllers</label>
      <select name="ps5_controllers" required>
        <option value="1">1 Controller</option>
        <option value="2">2 Controllers</option>
        <option value="3">3 Controllers</option>
        <option value="4">4 Controllers</option>
      </select>

      <label>Duration</label>
      <select name="ps5_duration" id="ps5_duration" required>
        <option value="">Select</option>
        <option value="30">Half Hour</option>
        <option value="60">1 Hour</option>
      </select>

      <label>From Time</label>
      <input type="time" name="from_time_ps5" id="ps5_from" required>

      <label>To Time (Auto)</label>
      <input type="time" id="ps5_to" disabled>

      <button class="btn">‚ûï Add PS5</button>
    </form>
  </div>


  <!-- üçî FOOD ZONE -->
  <div class="card wide">
    <h2>üçî Food Zone</h2>

    <form method="post" class="foodform">
      {% csrf_token %}
      <input type="hidden" name="action" value="add_food">

      <select id="foodSelect" name="food_item" required>
        <option value="">Select Food</option>
        {% for name, price in menu.items %}
          <option value="{{ name }}" data-price="{{ price }}">{{ name }}</option>
        {% endfor %}
      </select>

      <input type="number" id="foodPrice" placeholder="Price" readonly>
      <input type="number" name="food_qty" placeholder="Qty" required min="1">

      <button class="btn">‚ûï Add Food</button>
    </form>

    <p class="note">‚úÖ Price auto-fills in separate field</p>
  </div>


  <!-- üéÅ COMBOS -->
  <div class="card wide">
    <h2>üéÅ Gaming Combos</h2>

    <form method="post" class="comboform">
      {% csrf_token %}
      <input type="hidden" name="action" value="add_combo">

      <select name="combo_name" required>
        <option value="">Select Combo</option>
        {% for cname, cprice in combos.items %}
          <option value="{{ cname }}">{{ cname }} ‚Äî Rs. {{ cprice }}</option>
        {% endfor %}
      </select>

      <button class="btn">‚ûï Add Combo</button>
    </form>
  </div>


  <!-- üè∑Ô∏è DISCOUNTS -->
  <div class="card wide">
    <h2>üè∑Ô∏è Discounts</h2>

    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="action" value="apply_discounts">

      <div class="row2">
        <div>
          <label>Food Discount (%)</label>
          <input type="number" name="food_disc_percent" value="{{ food_disc_percent }}" placeholder="Ex: 10">
        </div>

        <div>
          <label>Gaming Discount (Rs.)</label>
          <input type="number" name="game_disc_amount" value="{{ game_disc_amount }}" placeholder="Ex: 50">
        </div>
      </div>

      <button class="btn">‚úÖ Apply Discounts</button>
    </form>
  </div>


  <!-- üßæ BILL ITEMS -->
  <div class="card wide">
    <h2>üßæ Bill Items</h2>

    {% if items %}
    <table class="billtable">
      <tr>
        <th>Item</th>
        <th>Qty</th>
        <th>Rate</th>
        <th>Total</th>
        <th>Remove</th>
      </tr>

      {% for i in items %}
      <tr>
        <td>{{ i.item_name }}</td>
        <td>
          {% if i.category == "GAME" %}
            {{ i.quantity }} hr
          {% else %}
            {{ i.quantity }}
          {% endif %}
        </td>
        <td>Rs. {{ i.rate }}</td>
        <td>Rs. {{ i.total }}</td>
        <td><a class="remove" href="{% url 'billing:remove_item' i.id %}">‚ùå</a></td>
      </tr>
      {% endfor %}
    </table>
    {% else %}
      <p class="note">No items added yet.</p>
    {% endif %}

    <div class="summary">
      <p>Food Subtotal: <span>Rs. {{ totals.food_subtotal }}</span></p>
      <p>Game Subtotal: <span>Rs. {{ totals.game_subtotal }}</span></p>
      <p>Combo Subtotal: <span>Rs. {{ totals.combo_subtotal }}</span></p>
      <p>Food Discount: <span>- Rs. {{ totals.food_discount }}</span></p>
      <p>Game Discount: <span>- Rs. {{ totals.game_discount }}</span></p>
      <hr>
      <p class="grand">Total: <span>Rs. {{ totals.grand_total }}</span></p>
    </div>

    <div class="actions">
      <form method="post" action="{% url 'billing:mark_paid' %}">
        {% csrf_token %}
        <button class="btn pay">‚úÖ Mark Paid & Print + Send Mail</button>
      </form>

      <a href="{% url 'billing:new_bill' %}" class="btn dark">üßæ New Bill</a>
      <a href="{% url 'billing:dashboard' %}" class="btn dark">üìä Dashboard</a>
      <a href="{% url 'logout' %}" class="btn dark">Logout</a>
    </div>
  </div>

</div>


<script>
  // ‚úÖ Food price auto-fill (separate field)
  const foodSelect = document.getElementById("foodSelect");
  const foodPrice = document.getElementById("foodPrice");

  foodSelect.addEventListener("change", function(){
    let selected = foodSelect.options[foodSelect.selectedIndex];
    let price = selected.getAttribute("data-price");
    foodPrice.value = price ? price : "";
  });

  // ‚úÖ Auto To-Time logic
  function addMinutes(time, mins){
    if(!time) return "";
    let [h,m] = time.split(":").map(Number);
    let date = new Date();
    date.setHours(h);
    date.setMinutes(m + mins);
    let hh = String(date.getHours()).padStart(2,"0");
    let mm = String(date.getMinutes()).padStart(2,"0");
    return `${hh}:${mm}`;
  }

  // Pool Auto To
  const poolFrom = document.getElementById("pool_from");
  const poolTo = document.getElementById("pool_to");
  const poolDur = document.getElementById("pool_duration");

  function updatePoolTo(){
    let mins = poolDur.value === "30" ? 30 : 60;
    poolTo.value = addMinutes(poolFrom.value, mins);
  }
  poolFrom.addEventListener("change", updatePoolTo);
  poolDur.addEventListener("change", updatePoolTo);

  // PS5 Auto To
  const ps5From = document.getElementById("ps5_from");
  const ps5To = document.getElementById("ps5_to");
  const ps5Dur = document.getElementById("ps5_duration");

  function updatePs5To(){
    let mins = ps5Dur.value === "30" ? 30 : 60;
    ps5To.value = addMinutes(ps5From.value, mins);
  }
  ps5From.addEventListener("change", updatePs5To);
  ps5Dur.addEventListener("change", updatePs5To);
</script>

</body>
</html>
