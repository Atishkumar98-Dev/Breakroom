{% load static %}
<!DOCTYPE html>
<html>
<head>
<title>Add Food</title>

<link rel="stylesheet" href="{% static 'pos/style.css' %}">

<style>

.menu-grid{
    display:flex;
    flex-direction:column;
    gap:25px;
}

.category-grid{
    display:grid;
    grid-template-columns: repeat(auto-fill, minmax(150px,1fr));
    gap:10px;
}

.food-btn{
    background:#111;
    color:#fff;
    border:none;
    padding:16px;
    border-radius:12px;
    cursor:pointer;
    font-weight:600;
}

.food-btn:hover{
    background:#28a745;
}

.cart-box{
    /* background:#fafafa; */
    padding:15px;
    border-radius:10px;
    margin-bottom:20px;
}

.cart-item{
    display:flex;
    justify-content:space-between;
    margin-bottom:8px;
    color: #f5c400;
}

.search{
    width:100%;
    padding:12px;
    font-size:16px;
    margin-bottom:20px;
}

.qty-btn{
    margin-left:5px;
}

</style>
</head>

<body>

<div class="topbar">
  <a href="{% url 'pos:bill_summary' %}" class="btn dark">‚¨Ö Bill</a>
  <h2>üçî Add Food</h2>
  <span class="billno">{{ bill.bill_no }}</span>
</div>


<div class="card wide">

<form method="post" onsubmit="prepareCart()">
{% csrf_token %}

<input type="hidden" name="cart_data" id="cartData">

<!-- SEARCH -->
<input 
    type="text"
    id="foodSearch"
    class="search"
    placeholder="üîç Search food..."
    autofocus
>

<!-- CART -->
<div class="cart-box">
    <h3>üõí Selected Items</h3>
    <div id="cart"></div>
</div>

<button class="btn">‚úÖ Add Items To Bill</button>

<br><br>

<div class="menu-grid">

{% for category in categories %}

<h2>{{category.name}}</h2>

<!-- PRODUCTS WITHOUT SUBCATEGORY -->
<div class="category-grid">

{% for product in category.products.all %}
{% if not product.subcategory and product.is_available %}

<button 
    type="button"
    class="food-btn food-item"
    data-id="{{product.id}}"
    data-name="{{product.name|escapejs}}"
    data-price="{{product.price}}"
    data-search="{{product.name|lower}} {{category.name|lower}}"
>
    {{product.name}}
    <br>
    ‚Çπ{{product.price}}
</button>

{% endif %}
{% endfor %}

</div>


<!-- SUBCATEGORIES -->
{% for sub in category.subcategories.all %}

<h3>üëâ {{sub.name}}</h3>

<div class="category-grid">

{% for product in sub.products.all %}
{% if product.is_available %}

<button 
    type="button"
    class="food-btn food-item"
    data-id="{{product.id}}"
    data-name="{{product.name|escapejs}}"
    data-price="{{product.price}}"
    data-search="{{product.name|lower}} {{sub.name|lower}} {{category.name|lower}}"
>
    {{product.name}}
    <br>
    ‚Çπ{{product.price}}
</button>

{% endif %}
{% endfor %}

</div>

{% endfor %}
{% endfor %}

</div>
</form>
</div>


<script>

/* ================= CLICK HANDLER ================= */
/* ‚≠ê NO INLINE JS ‚Äî NEVER BREAKS */

document.addEventListener("click", function(e){

    const btn = e.target.closest(".food-btn");

    if(!btn) return;

    addToCart(
        btn.dataset.id,
        btn.dataset.name,
        btn.dataset.price
    );

});


/* ================= CART ================= */

let cart = {};

function addToCart(id,name,price){

    if(cart[id]){
        cart[id].qty++;
    }else{
        cart[id] = {
            name:name,
            price:parseFloat(price),
            qty:1
        };
    }

    renderCart();
}


function renderCart(){

    let html="";
    let total=0;

    for(const id in cart){

        let item=cart[id];
        let subtotal=item.qty*item.price;
        total+=subtotal;

        html+=`
        <div class="cart-item">
            <div>
                <b>${item.name}</b><br>
                ‚Çπ${item.price} √ó ${item.qty}
            </div>

            <div>
                <button type="button"
                    onclick="changeQty('${id}',-1)">‚ûñ</button>

                <button type="button"
                    onclick="changeQty('${id}',1)">‚ûï</button>

                <button type="button"
                    onclick="removeItem('${id}')">‚ùå</button>
            </div>
        </div>`;
    }

    html+=`<hr><b>Total: ‚Çπ${total}</b>`;

    document.getElementById("cart").innerHTML=html;
    document.getElementById("cartData").value=
        JSON.stringify(cart);
}


function changeQty(id,delta){

    cart[id].qty+=delta;

    if(cart[id].qty<=0){
        delete cart[id];
    }

    renderCart();
}


function removeItem(id){
    delete cart[id];
    renderCart();
}


function prepareCart(){

    if(Object.keys(cart).length===0){
        alert("Cart empty!");
        event.preventDefault();
        return;
    }

    document.getElementById("cartData").value=
        JSON.stringify(cart);
}


/* ================= SAFE SEARCH ================= */

document.getElementById("foodSearch")
.addEventListener("input", function(){

    let term = this.value.toLowerCase().trim();

    document.querySelectorAll(".food-item")
    .forEach(btn => {

        const searchable = btn.dataset.search;

        btn.hidden = !searchable.includes(term);

    });

});

</script>

</body>
</html>
